name: Encoding Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  check-encoding:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for replacement characters (U+FFFD)
      run: |
        echo "Checking for replacement characters (�) in files..."
        if grep -r "�" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.json" --include="*.md" --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=.next .; then
          echo "❌ Found replacement characters (�) in files above. This indicates encoding issues."
          exit 1
        else
          echo "✅ No replacement characters found."
        fi
    
    - name: Check for common encoding issues
      run: |
        echo "Checking for common Japanese encoding issues..."
        if grep -r -E "ポ�E|フルスタチE|AI×�E動化|戻めE|チE|ぁE|めE|確竁E" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.json" --include="*.md" --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=.next .; then
          echo "❌ Found encoding issues in files above."
          exit 1
        else
          echo "✅ No encoding issues found."
        fi
    
    - name: Validate file encodings
      run: |
        echo "Checking file encodings..."
        find . -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.json" -o -name "*.md" | \
        grep -v node_modules | grep -v .git | grep -v .next | \
        while read file; do
          encoding=$(file -b --mime-encoding "$file")
          if [[ ! "$encoding" =~ ^(utf-8|us-ascii)$ ]]; then
            echo "❌ File $file has unexpected encoding: $encoding"
            exit 1
          fi
        done
        echo "✅ All files have valid UTF-8 encoding."